[TOC]

## 引子
- 按照创建时间作为分片键，按月成功分表了；
- 业务继续保持增长；


## 回顾
分片键的选取，为什么选择了创建时间？

#### 1. 取模的方案：
即对业务进行预估，估计出能跑多久，能有多少量进来。预估个数字`biz_total_num`，按照这个数字，再根据mysql 对数据数量的最佳理论支持-2kw（按三层高度、主键8b+索引6b，每条数据1kb计算），`biz_total_num/2kw`相除，得到最佳的表数量`t_num`。

有了`t_num`之后，可以按顺序建各个分表了，id可以取模，可以均匀分散上去了。

优点：
- 数据分散，读写不会集中出现在一个表上

缺点：
- 计算均建立在想象当中，多了，需要对业务重新预估，重新得到新的表数量，所有数据重新取模，洗到新的表中

#### 2. 按ID范围
id自增，依旧预最佳估数据量是2kw，每张表到这个数则换一张表，即：
- table_0放id 为 1 ~ 2千万的数据；
- table_1放id 为 2+1千万 ~ 4千万；
- table_2放id 为 4+1千万 ~ 6千万；
- table_N放2N千万+1 ~ 2(N+1)千万。

优点：
不用担心业务增长带来数据的不确定性，方案可以在较长的一段时间保持不变

缺点：
热点数据

mta能这样吗？不能，场景包括下面列举的
1. 在质检时的insert、delete操作，大约仅在1min内有10~20次的批量操作
2. 对询价单、订单关联的质检报告做查询，均在数据已经固定，没有变更的情况下做读的操作
3. 对关联表做的分表，只能知道主表id。分表id没有意义，没有存在感

#### 3. 每月都使用不同的表
表格每半年用job提前建立好，避免出现抢资源的情况。再用创建时间作为分片键，按年、月规则组成表名，直接操作。

## 其他问题
自己系统遇到的问题不难，基本操作就可以解决。
#### 热点表
真的出现热点表怎么办？分表规则都是自己定的，面对不确定的数据增长，依旧可以采用2、3的方案，再对每张表做Hash取模的操作，此时可以分掉热点。这些表分到不同的库效果会更加明显

#### 查询
分表后查询：推荐带上分片键，中间件可以根据原先的分片规则计算出目标表，有目的性的查询。但是查询，最一般的情况就是会避开分片键，比如想收集某个imei的报告。此时没有分片键，就会出现`读扩散`，即没法计算出要去哪张表，只能所有表查一遍。分表越多，效率越低。

有没有方案可以自己解决自己的问题呢，**引入新表再来做一次分表**，新表只有分片键和imei，此时用imei做分片键。当要查询imei列时，先到这个新的分片表里做一次查询，就能迅速定位到对应的原分片键，然后再拿原分片键与imei去表里查一次数据。这样就从原来漫无目的的全表扩散查询，缩减为只查固定几个表了。当然，新表可以直接落主键id，可以更为精确获取。

缺点也很明显，这只是一个条件查询，如果更一般的情况，如果又有新的查询条件，而且还想联合查询，那每个组合都要维护一张表，这张表就像一张索引，还要写索引更新的逻辑。情况将会变得更加复杂，也更为别扭，已经可以考虑其他轮子了。像这种，通过imei列反查原数据的思想，很类似于**倒排索引**。相当于我们是利用了倒排索引的思路去解决分表下的数据查询问题。

总结一下上面的思路，其实我们无非就是在大量数据的场景下依然能提供普通索引列或其他更多维度的查询。这种场合，直接上es，es天然分片，而且内部利用倒排索引的形式来加速数据查询。

如果使用es，它会在它内部以进行分片，data节点，持有数据和倒排索引。这是不是就跟上面做的事情没啥区别。