[TOC]

## 名词
> 线程数，并发数，吞吐量，每秒事务数（TPS）都是性能测试领域非常关键的数据和指标。
> [生动例子](https://www.bbsmax.com/A/Vx5M3WXazN/)

### 线程数
实现性能测试的一个必要条件，必须要能模拟高峰期的访问量，这里就需要性能测试工具来帮忙了，如JMeter。多线程式并发测试工具，顾名思义，会启动复数个线程，让每个线程独立向服务器端发出请求。

**有时候我们在描述性能测试过程时，会将这个客户端的独立线程数表述为“并发数”**。但是注意，这里的“并发”指的是客户端并发，很简单，客户端能发出很多请求，服务器却未必能处理得了。

### 并行数
服务器一次性能同时处理多少事务请求呢？根据我们之前的讨论，同一时间节点上同时处理的事务数最大就是：CPU处理器数*服务器超线程倍率。

比如对于一个8核未超线程CPU，某时间节点上的同时处理的事务不会超过8个。这里我们描述的“同时8个”事务，就是“并行/平行”的含义。

### 并发数
并发数指的是一个时间段内的事务完成数。这个切片“时间段”常取1秒钟或1分钟这样的整数来做换算。（每秒请求量、每分钟请求量）

### 每秒事务数（TPS）
> TPS - Transaction Per Seconds。是衡量服务器性能的最重要也是最直观指标

常见的事务请求在应用服务器端的处理时间以毫秒为单位计算。所以测试性能时，我们更常用“1秒钟”来作为切片时间段。

一秒钟完成多少个事务请求，这个数据就是我们耳熟能详的“每秒事务数”。

### QPS
> QPS - Query Per Seconds

一次事务T 可能进行了多次服务器请求Q

### 平均响应时间
有哪些因素会影响到TPS数值？有两个主要的维度：
1. 单个事务响应速度
2. 同一时间能并行执行的事务

第一点，换一个说法就是事务平均响应时间。单个事务平均下来完成的速度越快，那么单位时间内能完成的事务数就越多，TPS就越高；
第二点，它主要跟服务器资源配置，线程池容量，线程调度等相关。

进行性能调优时，除了服务器容量资源，单个事务响应速度是另一个关注的重点。
要关注事务响应速度/时间，可以考虑在事务内部逻辑节点添加“耗时探针”（arthas）的方式，来探测每个步骤分别花费的时间，从而找出可优化的部分。

### 吞吐量
> 吞吐量是站在“量”的角度去度量，是一个参考指标。指单位时间内系统传输的数据量，以MB/GB等为单位

性能测试领域的吞吐量通常会结合上时间维度进行统计。如果吞吐量的“量”以“事务”为统计单位的话，结合时间维度，转化以后可以很容换算成TPS。

## 压测
性能测试可能存在很多种形式。比如明确了解日访问量和巅峰访问量，测试服务器是否能够承受响应压力的测试。比如用于探测系统负载极限和性能拐点的测试。比如衡量系统在高负载情况下，长时间运行是否稳定的测试。

这许多种形式我们暂且不做讨论，不过所有以上测试的基础都是它 -- “并发测试”。制造并发，是性能测试的基本实现办法。

### 客户端线程数和并发量的关系

### 线程并发数量
制造多少并发，换言之，我应该用多少并发线程数去进行测试？
实际上客户端发起的线程数与服务器可达到的并发数**并无直接关系**，但你应该使用足够的线程数，让服务器达到事务饱和。

如何判断服务器是否达到饱和？这时我们可以采取阶梯增压的方式，不断加大客户端线程数量，直到服务器处理不过来，事务频繁超时，这时就得到了服务器处理能力极限。

根据不同的测试类型，取这个极限数量的一定百分比作为客户端线程数。比如说，负载测试中，通常取达到这个极限数值的70%。

### 客户端损耗
客户端从启动线程到构造请求并发出，这一过程也有一定的时间损耗。通常在测试服务器性能的时候，客户端性能是应该被剥离出去的，所以测试时应该尽量降低客户端时间损耗。
1. 适当增加客户端线程循环次数 - 稀释这些线程启动的占用时间
2. 当客户端线程数需要较大数量时（对jmeter而言，超过1000左右），客户机/测试机的资源占用会增大，整个客户端的请求构造时间会拉长。应该考虑分布式测试。
3. 尽量减少客户端请求构造时间，比如beanshell请求加密，如果过程过于复杂也会耗去可观时间。极限测试情况下应考虑简化。

## 事例
### 操作工具：阿里云性能测试PTS
- 创建场景：
  - 输入压测接口，断言写好、数据源、调试；
  - 施压配置，压力公网，手动调速，指定IP数，流量地域定制（北京）；
  - 关于模式，并发模式（虚拟用户模式）需要设置最大并发，影响tps，即跑压测的时候最大会到这。RPS模式，固定手动调速，压测时直接指定tps的量，工具会根据情况增加/减少线程来维持tps；
- 压测时看：
  - 关注日志采样的请求接口返回是正常业务返回（防止未考虑到的错误），以及成功率；
  - 关注tps、平均RT波动是否剧烈；
  - 关注压测机的性能，防止成为压测瓶颈，比如cpu，内存，网络带宽；
  - 关注自己服务cpu，内存，垃圾回收的情况；
- 压测完的报告：
  - 时间：平均时间、tp99、tp999
  - tps指标
### 关于开发
- 看慢接口，APM跟踪，找出慢的接口、sql、redis
- 检查自家服务cpu、内存、线程池子的表现
- 看别家服务的cpu、内存、线程池子的表现
- 看看公网的流量是否到了瓶颈
- 看请求从公网到服务的跳转路径